name: Ralph Autofix Agent

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number"
        required: true
      issue_title:
        description: "Issue title"
        required: true
      issue_body:
        description: "Issue body"
        required: true
      issue_labels:
        description: "Comma-separated labels on the issue (e.g. 'frontend,bug')"
        required: false
        default: ""

# Only one run per issue at a time.
concurrency:
  group: clanker-autofix-${{ github.event.issue.number || inputs.issue_number }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  autofix:
    if: github.event_name == 'workflow_dispatch' || github.event.label.name == 'clanker-autofix'
    runs-on: ubuntu-latest
    timeout-minutes: 90

    env:
      ISSUE_NUMBER: ${{ github.event.issue.number || inputs.issue_number }}
      ISSUE_TITLE: ${{ github.event.issue.title || inputs.issue_title }}
      ISSUE_BODY: ${{ github.event.issue.body || inputs.issue_body }}
      ISSUE_LABELS: ${{ join(github.event.issue.labels.*.name, ',') || inputs.issue_labels }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      RALPH_REPO_ROOT: ${{ github.workspace }}

    steps:
      # ── Environment Setup ─────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Setup uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install project dependencies
        run: npm ci

      - name: Install Python dependencies
        run: uv sync

      - name: Install Cline CLI
        run: npm install -g cline@latest

      - name: Install Playwright MCP server and browsers
        run: |
          npm install -g @playwright/mcp@latest
          npx playwright install --with-deps chromium

      # ── Validate secrets ──────────────────────────────────────
      - name: Validate required secrets
        run: |
          if [ -z "$OPENROUTER_API_KEY" ]; then
            echo "::error::OPENROUTER_API_KEY secret is not set. Configure it in Settings > Secrets."
            exit 1
          fi

          # Verify the key is actually accepted by OpenRouter (catches wrong/expired keys early)
          HTTP_STATUS=$(curl -s -o /tmp/or_key_check.json -w "%{http_code}" \
            -H "Authorization: Bearer $OPENROUTER_API_KEY" \
            https://openrouter.ai/api/v1/key)

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "::error::OPENROUTER_API_KEY is set but rejected by OpenRouter (HTTP $HTTP_STATUS)."
            echo "Response: $(cat /tmp/or_key_check.json)"
            echo "Check that the key is correct and has not expired: https://openrouter.ai/keys"
            exit 1
          fi

          echo "OPENROUTER_API_KEY validated successfully (HTTP 200)."

      # ── Run agent Python tests ────────────────────────────────
      - name: Check agent scripts for syntax errors
        run: |
          find clanker tests -name "*.py" | xargs uv run python -m py_compile
          echo "All Python files passed syntax check."

      - name: Run agent unit tests
        run: uv run pytest tests/ -v --tb=short

      # ── Main Agent ────────────────────────────────────────────
      - name: Run Ralph Agent
        id: agent
        run: uv run clanker-agent

      # ── Scrub Cline working dirs (contain secrets.json) ───────
      # Runs immediately after the agent, before upload/review steps,
      # so secrets are never present when any following step could
      # accidentally stage or expose them.
      - name: Remove Cline agent working directories
        if: always()
        run: rm -rf .cline-agent .cline-vision .cline-reviewer-* .cline-fixer-*

      # ── Upload Screenshots ────────────────────────────────────
      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: clanker-screenshots-${{ github.event.issue.number || inputs.issue_number }}
          path: screenshots/
          if-no-files-found: ignore

      # ── Self-Review ───────────────────────────────────────────
      - name: Self-Review (fresh context)
        if: steps.agent.outcome == 'success'
        run: uv run clanker-review
        env:
          PR_NUMBER: ${{ steps.agent.outputs.pr_number }}
          BRANCH: ${{ steps.agent.outputs.branch }}
          ISSUE_LABELS: ${{ join(github.event.issue.labels.*.name, ',') || inputs.issue_labels }}

      # ── Failure Handling ──────────────────────────────────────
      - name: Post failure comment on issue
        if: failure()
        run: |
          gh issue comment "$ISSUE_NUMBER" \
            --body "**Ralph Agent** failed to resolve this issue automatically.

          Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

          ---
          *Automated by Ralph Agent*"
