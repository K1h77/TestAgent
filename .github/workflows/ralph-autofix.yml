name: Ralph Autofix Agent

on:
  issues:
    types: [labeled]

# Prevent duplicate runs for the same issue
concurrency:
  group: ralph-autofix-${{ github.event.issue.number }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  autofix:
    if: github.event.label.name == 'ralph-autofix'
    runs-on: ubuntu-latest
    timeout-minutes: 45

    env:
      ISSUE_NUMBER: ${{ github.event.issue.number }}
      ISSUE_TITLE: ${{ github.event.issue.title }}
      ISSUE_BODY: ${{ github.event.issue.body }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      # ── Environment Setup ─────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install project dependencies
        run: npm ci

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Install Cline CLI and configure
        run: |
          npm install -g cline@latest
          mkdir -p ~/.cline/data
          cat > ~/.cline/data/globalState.json << 'CONF'
          {
            "welcomeViewCompleted": true,
            "actModeApiProvider": "openrouter",
            "actModeApiModelId": "minimax/minimax-m2.5",
            "planModeApiProvider": "openrouter",
            "planModeApiModelId": "google/gemini-3-flash-preview"
          }
          CONF
          echo "{\"apiKey\": \"$OPENROUTER_API_KEY\"}" > ~/.cline/data/secrets.json

      - name: Install Playwright MCP server and browsers
        run: |
          npm install -g @playwright/mcp@latest
          npx playwright install --with-deps chromium

      # ── Validate secrets ──────────────────────────────────────
      - name: Validate required secrets
        run: |
          if [ -z "$OPENROUTER_API_KEY" ]; then
            echo "::error::OPENROUTER_API_KEY secret is not set. Configure it in Settings > Secrets."
            exit 1
          fi
          echo "All required secrets are configured."

      # ── Run agent Python tests ────────────────────────────────
      - name: Run agent unit tests
        run: python -m pytest .github/scripts/tests/ -v --tb=short

      # ── Main Agent ────────────────────────────────────────────
      - name: Run Ralph Agent
        id: agent
        run: python .github/scripts/ralph_agent.py

      # ── Upload Screenshots ────────────────────────────────────
      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ralph-screenshots-${{ github.event.issue.number }}
          path: screenshots/
          if-no-files-found: ignore

      # ── Self-Review ───────────────────────────────────────────
      - name: Self-Review (fresh context)
        if: steps.agent.outcome == 'success'
        run: python .github/scripts/self_review.py
        env:
          PR_NUMBER: ${{ steps.agent.outputs.pr_number }}
          BRANCH: ${{ steps.agent.outputs.branch }}

      # ── Failure Handling ──────────────────────────────────────
      - name: Post failure comment on issue
        if: failure()
        run: |
          gh issue comment "$ISSUE_NUMBER" \
            --body "**Ralph Agent** failed to resolve this issue automatically.

          Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

          ---
          *Automated by Ralph Agent*"
